<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flipkart Smart Assistant</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="brand">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="logo" class="brand-logo" />
        <div>
          <h1>Flipkart Smart Assistant</h1>
          <p class="tag">Ask, Discover & Shop Smarter</p>
        </div>
      </div>
    </header>

    <main class="main-area">
      <section class="chat-panel" id="chat-panel">
        <!-- initial welcome bubble -->
        <div class="bubble bot">
          <strong>üëã Hi! I‚Äôm your Flipkart AI shopping assistant.</strong><br>
          Ask anything ‚Äî e.g. ‚Äú5 phones under ‚Çπ50,000‚Äù or ‚Äúbest laptops under 60k‚Äù.
        </div>
      </section>

      <aside class="product-panel" id="product-panel" aria-live="polite">
        <div id="product-header" class="product-header hidden"></div>
        <div id="product-grid" class="product-grid"></div>
      </aside>
    </main>

    <footer class="composer">
      <form id="chat-form" class="composer-form" autocomplete="off">
        <input id="user-input" name="msg" type="text" placeholder="Search products or chat with AI..." />
        <button type="submit" aria-label="send">‚û§</button>
      </form>
    </footer>
  </div>

  <script>
    const chatPanel = document.getElementById('chat-panel');
    const productPanel = document.getElementById('product-panel');
    const productGrid = document.getElementById('product-grid');
    const productHeader = document.getElementById('product-header');
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');

    function createBubble(text, cls = 'bot') {
      const div = document.createElement('div');
      div.className = `bubble ${cls}`;
      // if text has HTML (explanation may be HTML from LLM) render it
      if (/<[a-z][\s\S]*>/i.test(text)) div.innerHTML = text;
      else div.textContent = text;
      chatPanel.appendChild(div);
      chatPanel.scrollTop = chatPanel.scrollHeight;
      return div;
    }

    function clearProducts() {
      productHeader.classList.add('hidden');
      productGrid.innerHTML = '';
    }

    function renderProducts(products, query) {
      productHeader.classList.remove('hidden');
      productHeader.innerHTML = `<strong>Results for:</strong> <span class="query-text">${escapeHtml(query)}</span>`;

      productGrid.innerHTML = products.map((p, idx) => {
        const id = p.id || `prod-${idx+1}`;
        const title = escapeHtml(p.title || 'Unknown Product');
        const summary = escapeHtml(p.summary || '');
        const rating = escapeHtml(String(p.rating || 'N/A'));
        return `
          <article class="product-card" id="${id}">
            <div class="thumb" aria-hidden="true">üì¶</div>
            <h3 class="prod-title">${title}</h3>
            <p class="prod-desc">${summary}</p>
            <div class="card-foot">
              <div class="rating">‚≠ê ${rating}</div>
              <button class="btn primary view-btn" data-id="${id}">View</button>
            </div>
          </article>
        `;
      }).join('');
      productPanel.scrollTop = productPanel.scrollHeight;
      // attach click behavior (delegate)
      productGrid.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = btn.dataset.id;
          const el = document.getElementById(id);
          if (el) {
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            el.classList.add('highlight');
            setTimeout(()=>el.classList.remove('highlight'), 1200);
          }
        });
      });
    }

    function escapeHtml(str) {
      return str
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function showTyping() {
      const loader = document.createElement('div');
      loader.className = 'bubble bot typing';
      loader.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
      chatPanel.appendChild(loader);
      chatPanel.scrollTop = chatPanel.scrollHeight;
      return loader;
    }

    chatForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const msg = userInput.value.trim();
      if (!msg) return;
      userInput.value = '';
      createBubble(msg, 'user');

      // show typing
      const loader = showTyping();

      try {
        const formData = new FormData();
        formData.append('msg', msg);
        const res = await fetch('/recommend', { method: 'POST', body: formData });
        const data = await res.json(); // expected { intent, explanation, products }

        // remove typing
        loader.remove();

        // If explanation present and intent is not pure shopping, show it
        if (data.explanation && (!data.products || data.products.length === 0)) {
          createBubble(data.explanation, 'bot');
          clearProducts();
          return;
        }

        // If products exist, render product grid and a short bot bubble (optional)
        if (data.products && data.products.length > 0) {
          // optional short label bubble
          const label = `Showing ${data.products.length} result${data.products.length>1?'s':''}`;
          createBubble(label, 'bot');

          // render product cards grid side-by-side
          renderProducts(data.products, msg);
        } else {
          // fallback polite reply
          createBubble(data.explanation || "I couldn't find products matching that.", 'bot');
          clearProducts();
        }

      } catch (err) {
        loader.remove();
        createBubble('‚ö†Ô∏è Server error ‚Äî please try again.', 'bot');
        console.error(err);
      }
    });

    // allow pressing Enter to focus and submit quickly
    userInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        chatForm.requestSubmit();
      }
    });
  </script>
</body>
</html>
